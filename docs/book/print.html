<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Homelab Setup Documentation</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Homelab Setup Documentation</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/leminkhoa/homelab" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="proxmox-homelab-setup"><a class="header" href="#proxmox-homelab-setup">Proxmox Homelab Setup</a></h1>
<p>This repository contains infrastructure-as-code for the automated deployment and configuration of a secure homelab environment on Proxmox, featuring HashiCorp Vault for secrets management and AWS integration for backend storage.</p>
<h2 id="disclaimer"><a class="header" href="#disclaimer">Disclaimer</a></h2>
<p>This project is in development status and subject to breaking changes.</p>
<p>Please do not run any code on your machine without understanding the provisioning flow, in case of data loss. Some configurations may perform destructive actions that are irreversible!</p>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>This project provides a <strong>semi-automated</strong> approach to setting up a secure homelab infrastructure using modern DevOps practices:</p>
<ol>
<li><strong>Packer</strong> creates base Proxmox VM templates from cloud images and ISOs</li>
<li><strong>Terraform</strong> provisions infrastructure components and manages Proxmox resources</li>
<li><strong>HashiCorp Vault</strong> provides secure secrets management with AWS KMS encryption</li>
<li><strong>AWS Integration</strong> for backend storage and encryption key management</li>
</ol>
<p>The setup focuses on security, automation, and best practices for homelab environments.</p>
<h2 id="features"><a class="header" href="#features">Features</a></h2>
<ul>
<li><input disabled="" type="checkbox" checked=""/>
Golden image creation with Packer for Ubuntu Server templates</li>
<li><input disabled="" type="checkbox" checked=""/>
Declarative Proxmox infrastructure management with Terraform</li>
<li><input disabled="" type="checkbox" checked=""/>
HashiCorp Vault deployment with AWS KMS encryption</li>
<li><input disabled="" type="checkbox" checked=""/>
Secure secrets management and retrieval</li>
<li><input disabled="" type="checkbox" checked=""/>
Proxmox user and role management</li>
<li><input disabled="" type="checkbox" checked=""/>
Local storage configuration</li>
<li><input disabled="" type="checkbox" checked=""/>
AWS S3 backend for Vault with KMS encryption</li>
<li><input disabled="" type="checkbox" checked=""/>
Automated certificate management</li>
<li><input disabled="" type="checkbox" checked=""/>
Infrastructure as Code best practices</li>
</ul>
<h2 id="getting-started"><a class="header" href="#getting-started">Getting Started</a></h2>
<p>This repository’s documentation is built with <a href="https://rust-lang.github.io/mdBook/">mdbook</a>, a Rust-based documentation engine for simplicity and speed.</p>
<p>To start your journey, navigate to <a href="./getting_started.html">Getting Started</a> and follow the instructions.</p>
<h2 id="folder-structure"><a class="header" href="#folder-structure">Folder Structure</a></h2>
<pre><code class="language-bash">.
├── docs/                               # Documentation
├── images/                             # Screenshots and diagrams
├── resources/
│   ├── aws/                            # AWS infrastructure
│   │   └── 00_proxmox_backend/         # S3 and KMS for Terraform and HashicorpVault backend
│   └── proxmox/                        # Proxmox infrastructure
│       ├── 00_proxmox_administration/  # Users, roles, storage
│       ├── 01_base_vm_template/        # Packer templates
│       └── 02_vault/                   # Vault deployment
└── README.md
</code></pre>
<h2 id="acknowledgements"><a class="header" href="#acknowledgements">Acknowledgements</a></h2>
<ul>
<li><a href="https://github.com/kencx/homelab/blob/master/README.md">kencx/homelab</a> - Inspiration for HashiCorp stack architecture</li>
<li><a href="https://github.com/ChristianLempa/homelab/tree/main/proxmox">ChristianLempa/homelab</a> - Proxmox automation patterns</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h1>
<h2 id="hardware-requirements"><a class="header" href="#hardware-requirements">Hardware Requirements</a></h2>
<p>This project can be run on any modern x86_64 system that meets the recommended system
requirements of <a href="https://pve.proxmox.com/wiki/System_Requirements">Proxmox</a>. I
recommend mini-SFF workstations such as those from <a href="https://www.servethehome.com/introducing-project-tinyminimicro-home-lab-revolution/">Project
TinyMiniMicro</a>.
Alternatively, you may choose to run the Proxmox cluster on your own PC for simple setup.</p>
<h3 id="my-current-setup"><a class="header" href="#my-current-setup">My Current Setup</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Component</th><th>Specification</th><th>Details</th></tr></thead><tbody>
<tr><td><strong>Proxmox Node</strong></td><td>PC Gaming MS-7B19</td><td>1x Physical Server</td></tr>
<tr><td><strong>CPU</strong></td><td>Intel Core i5-8500</td><td>6 cores @ 3.00GHz, 1 socket, x86_64</td></tr>
<tr><td><strong>RAM</strong></td><td>16GB DDR4</td><td>2x 8GB modules</td></tr>
<tr><td><strong>Storage</strong></td><td>1TB SSD</td><td>OS and VM storage</td></tr>
<tr><td><strong>Network Switch</strong></td><td>TP-Link 5 Port Gigabit</td><td>Network bridge configuration</td></tr>
<tr><td><strong>WiFi Integration</strong></td><td>TP-Link WiFi Adapter</td><td>Connected via bridge mode for wireless LAN</td></tr>
<tr><td><strong>Proxmox Version</strong></td><td>VE 8.4.1</td><td>Current deployment version</td></tr>
</tbody></table>
</div>
<p>While a separate router and NAS is recommended, I run a virtualized instance of both within Proxmox itself.</p>
<h2 id="proxmox-node"><a class="header" href="#proxmox-node">Proxmox Node</a></h2>
<p>A Proxmox Virtual Environment (PVE) server is required to host the virtual machines and containers. For detailed installation instructions, see the <a href="./proxmox_installation.html">Proxmox Installation Guide</a>.</p>
<h2 id="controller-node-your-laptop"><a class="header" href="#controller-node-your-laptop">Controller Node (Your Laptop)</a></h2>
<p>A workstation/laptop/PC or separate host system will be used to run the
required provisioning tools. This system will need to have the following tools
installed:</p>
<div class="table-wrapper"><table><thead><tr><th>Tool</th><th>Purpose</th><th>Key Features</th><th>Installation Link</th></tr></thead><tbody>
<tr><td><strong>Packer</strong></td><td>VM Image Building</td><td>• Automated VM template creation<br>• Multi-platform support (VMware, VirtualBox, etc.)<br>• Infrastructure as Code for images<br>• Integration with cloud providers</td><td><a href="https://developer.hashicorp.com/packer/install">Install Packer</a></td></tr>
<tr><td><strong>Terraform</strong></td><td>Infrastructure Provisioning</td><td>• Declarative infrastructure management<br>• State management and tracking<br>• Multi-cloud and on-premises support<br>• Plan and apply workflow<br>• Resource dependency management</td><td><a href="https://developer.hashicorp.com/terraform/install">Install Terraform</a></td></tr>
<tr><td><strong>Mdbook</strong></td><td>Documentation Generation</td><td>• Static site generation from Markdown<br>• Built-in search functionality<br>• Responsive design<br>• Syntax highlighting<br>• Table of contents generation</td><td><a href="https://rust-lang.github.io/mdBook/guide/installation.html">Install Mdbook</a></td></tr>
</tbody></table>
</div>
<blockquote>
<p><strong>Note</strong>: This documentation was tested with Packer v1.14.x and Terraform v1.13.x. While newer versions should work, please verify compatibility if you encounter any issues.</p>
</blockquote>
<h2 id="cluster-requirements"><a class="header" href="#cluster-requirements">Cluster Requirements</a></h2>
<ul>
<li>An existing Proxmox server that is reachable by the controller node</li>
<li>(Optional) An offline, private root and intermediate CA.</li>
<li>A self-signed certificate, private key for TLS encryption of Vault.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="proxmox-node-installation-guide"><a class="header" href="#proxmox-node-installation-guide">Proxmox Node Installation Guide</a></h1>
<p>This guide will walk you through installing Proxmox Virtual Environment (PVE) on your hardware to create a Proxmox node for your homelab setup.</p>
<h2 id="prerequisites-1"><a class="header" href="#prerequisites-1">Prerequisites</a></h2>
<p>Before starting the installation, ensure your hardware meets the <a href="https://pve.proxmox.com/wiki/System_Requirements">Proxmox system requirements</a>:</p>
<ul>
<li><strong>CPU</strong>: 64-bit x86 processor with hardware virtualization support (Intel VT-x or AMD-V)</li>
<li><strong>RAM</strong>: Minimum 2GB, recommended 8GB or more</li>
<li><strong>Storage</strong>: Minimum 32GB for installation, recommended SSD for better performance</li>
<li><strong>Network</strong>: Ethernet connection for management interface</li>
</ul>
<h2 id="download-and-prepare-installation-media"><a class="header" href="#download-and-prepare-installation-media">Download and Prepare Installation Media</a></h2>
<ol>
<li>
<p><strong>Download Proxmox VE ISO</strong></p>
<ul>
<li>Visit the <a href="https://www.proxmox.com/en/downloads/proxmox-virtual-environment">Proxmox download page</a></li>
<li>Download the latest Proxmox VE ISO image</li>
<li>The ISO file is approximately 1.1GB</li>
</ul>
</li>
<li>
<p><strong>Create Bootable USB Drive</strong></p>
<ul>
<li>Use tools like <a href="https://rufus.ie/">Rufus</a> (Windows), <a href="https://www.balena.io/etcher/">Balena Etcher</a> (cross-platform), or <code>dd</code> command (Linux/macOS)</li>
<li>Write the ISO image to a USB flash drive (minimum 4GB capacity)</li>
</ul>
</li>
</ol>
<h2 id="installation-process"><a class="header" href="#installation-process">Installation Process</a></h2>
<h3 id="step-1-boot-from-installation-media"><a class="header" href="#step-1-boot-from-installation-media">Step 1: Boot from Installation Media</a></h3>
<ol>
<li>Insert the bootable USB drive into your target hardware</li>
<li>Power on the system and access the BIOS/UEFI settings</li>
<li>Configure the boot order to prioritize USB devices</li>
<li>Save settings and restart</li>
<li>Select “Install Proxmox VE” from the boot menu</li>
</ol>
<h3 id="step-2-installation-wizard"><a class="header" href="#step-2-installation-wizard">Step 2: Installation Wizard</a></h3>
<ol>
<li><strong>Welcome Screen</strong>: Press <code>Enter</code> to start the installation</li>
<li><strong>License Agreement</strong>: Accept the license terms</li>
<li><strong>Target Hard Disk</strong>:
<ul>
<li>Select the disk where Proxmox will be installed</li>
<li>⚠️ <strong>Warning</strong>: This will erase all existing data on the selected disk</li>
</ul>
</li>
<li><strong>Location and Time Zone</strong>: Configure your geographic location and timezone</li>
<li><strong>Administration Password</strong>: Set a strong password for the <code>root</code> user</li>
<li><strong>Network Configuration</strong>:
<ul>
<li>Configure the management interface (usually the first Ethernet port)</li>
<li>Set a static IP address or use DHCP</li>
<li>Configure hostname (e.g., <code>pve-node-01</code>)</li>
<li>Set DNS servers</li>
</ul>
</li>
</ol>
<h3 id="step-3-complete-installation"><a class="header" href="#step-3-complete-installation">Step 3: Complete Installation</a></h3>
<ol>
<li>Review your configuration settings</li>
<li>Click “Install” to begin the installation process</li>
<li>Wait for the installation to complete (typically 10-15 minutes)</li>
<li>Reboot the system when prompted</li>
<li>Remove the installation media</li>
</ol>
<h2 id="post-installation-configuration"><a class="header" href="#post-installation-configuration">Post-Installation Configuration</a></h2>
<h3 id="access-the-web-interface"><a class="header" href="#access-the-web-interface">Access the Web Interface</a></h3>
<p>After installation, you can access the Proxmox web interface:</p>
<ol>
<li><strong>Open a web browser</strong> and navigate to: <code>https://your-proxmox-ip:8006</code></li>
<li><strong>Accept the self-signed certificate</strong> warning (you can replace this with a proper certificate later)</li>
<li><strong>Login</strong> with:
<ul>
<li><strong>Username</strong>: <code>root</code></li>
<li><strong>Password</strong>: The password you set during installation</li>
<li><strong>Realm</strong>: <code>pam</code> (default)</li>
</ul>
</li>
</ol>
<p><img src="./proxmox_ui.png" alt="Proxmox Web Interface" /></p>
<h3 id="initial-system-configuration"><a class="header" href="#initial-system-configuration">Initial System Configuration</a></h3>
<ol>
<li>
<p><strong>Update the System</strong>:</p>
<pre><code class="language-bash">apt update &amp;&amp; apt upgrade -y
</code></pre>
</li>
<li>
<p><strong>Configure Storage</strong>:</p>
<ul>
<li>Navigate to <strong>Datacenter</strong> → <strong>Storage</strong></li>
<li>Add additional storage pools if needed (local, NFS, iSCSI, etc.)</li>
</ul>
</li>
<li>
<p><strong>Network Configuration</strong>:</p>
<ul>
<li>Verify network settings in <strong>System</strong> → <strong>Network</strong></li>
<li>Configure additional network interfaces if required</li>
</ul>
</li>
<li>
<p><strong>Subscription Management</strong>:</p>
<ul>
<li>For production use, consider purchasing a Proxmox subscription</li>
<li>For homelab use, you can use the free community repository</li>
</ul>
</li>
</ol>
<h3 id="verify-installation"><a class="header" href="#verify-installation">Verify Installation</a></h3>
<p>Check that your Proxmox node is properly configured:</p>
<ol>
<li><strong>System Information</strong>: Verify CPU, RAM, and storage are detected correctly</li>
<li><strong>Network Connectivity</strong>: Ensure the management interface is accessible</li>
<li><strong>Storage</strong>: Confirm local storage is available and properly configured</li>
<li><strong>Updates</strong>: Check that the system can access Proxmox repositories</li>
</ol>
<h2 id="next-steps"><a class="header" href="#next-steps">Next Steps</a></h2>
<p>With your Proxmox node successfully installed, you can now:</p>
<ol>
<li><strong>Create Virtual Machines</strong>: Use the web interface to create your first VMs</li>
<li><strong>Set up Containers</strong>: Deploy lightweight LXC containers</li>
<li><strong>Configure Backup</strong>: Set up automated backups for your VMs and containers</li>
<li><strong>Join a Cluster</strong>: Add additional nodes to create a high-availability cluster</li>
<li><strong>Deploy Infrastructure</strong>: Use the Terraform configurations in this repository to automate your homelab setup</li>
</ol>
<h2 id="troubleshooting"><a class="header" href="#troubleshooting">Troubleshooting</a></h2>
<h3 id="common-issues"><a class="header" href="#common-issues">Common Issues</a></h3>
<ul>
<li><strong>Network not accessible</strong>: Check firewall settings and network configuration</li>
<li><strong>Storage not detected</strong>: Verify disk connections and check for hardware issues</li>
<li><strong>Web interface not loading</strong>: Ensure the <code>pveproxy</code> service is running</li>
<li><strong>Certificate warnings</strong>: This is normal for self-signed certificates; you can replace them later</li>
</ul>
<h3 id="useful-commands"><a class="header" href="#useful-commands">Useful Commands</a></h3>
<pre><code class="language-bash"># Check system status
systemctl status pve-cluster

# View system logs
journalctl -u pve-cluster

# Restart Proxmox services
systemctl restart pve-cluster

# Check storage
pvesm status
</code></pre>
<h2 id="security-considerations"><a class="header" href="#security-considerations">Security Considerations</a></h2>
<ul>
<li><strong>Change default passwords</strong>: Use strong, unique passwords</li>
<li><strong>Configure firewall</strong>: Restrict access to management interfaces</li>
<li><strong>Regular updates</strong>: Keep the system updated with security patches</li>
<li><strong>Backup configuration</strong>: Regularly backup your Proxmox configuration</li>
<li><strong>Network isolation</strong>: Consider isolating management traffic from VM traffic</li>
</ul>
<p>For more detailed information, refer to the <a href="https://pve.proxmox.com/wiki/Main_Page">official Proxmox documentation</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="getting-started-1"><a class="header" href="#getting-started-1">Getting Started</a></h1>
<p>This guide provides the complete deployment sequence for a secure homelab environment on Proxmox with HashiCorp Vault and AWS integration.</p>
<h2 id="prerequisites-2"><a class="header" href="#prerequisites-2">Prerequisites</a></h2>
<p>Ensure all <a href="./prerequisites.html">prerequisites</a> are met before proceeding.</p>
<h2 id="quick-reference"><a class="header" href="#quick-reference">Quick Reference</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Step</th><th>Component</th><th>Purpose</th></tr></thead><tbody>
<tr><td>1</td><td>Trusted CA Store Configuration</td><td>Certificate trust configuration</td></tr>
<tr><td>2</td><td>AWS Backend</td><td>S3 storage and KMS encryption</td></tr>
<tr><td>3</td><td>Proxmox Admin</td><td>Users, roles, and storage setup</td></tr>
<tr><td>4</td><td>VM Templates</td><td>Base images for deployment</td></tr>
<tr><td>5</td><td>Vault Server</td><td>Secrets management infrastructure</td></tr>
</tbody></table>
</div>
<p>Follow each step sequentially for a complete homelab deployment.</p>
<h2 id="deployment-sequence"><a class="header" href="#deployment-sequence">Deployment Sequence</a></h2>
<h3 id="1-trusted-ca-store-configuration"><a class="header" href="#1-trusted-ca-store-configuration">1. Trusted CA Store Configuration</a></h3>
<p>Configure the controller node to trust Proxmox certificates for secure Terraform operations.</p>
<p><strong>Guidelines:</strong> <a href="./controller/trusted_ca_store.html">Trusted CA Store Configuration</a></p>
<h3 id="2-aws-backend-infrastructure"><a class="header" href="#2-aws-backend-infrastructure">2. AWS Backend Infrastructure</a></h3>
<p>Deploy AWS S3 and KMS infrastructure for secure state storage and encryption.</p>
<p><strong>Guidelines:</strong> <a href="./aws/index.html">AWS Configuration</a></p>
<h3 id="3-proxmox-administration"><a class="header" href="#3-proxmox-administration">3. Proxmox Administration</a></h3>
<p>Configure Proxmox users, roles, and storage for automation.</p>
<p><strong>Guidelines:</strong> <a href="./proxmox_setup/index.html">Proxmox Setup</a></p>
<h3 id="4-vm-template-creation"><a class="header" href="#4-vm-template-creation">4. VM Template Creation</a></h3>
<p>Build base VM templates using Packer for consistent deployments.</p>
<p><strong>Guidelines:</strong> <a href="./proxmox_setup/base_vm_template_ubuntu_server.html">Base VM Templates</a></p>
<h3 id="5-vault-infrastructure"><a class="header" href="#5-vault-infrastructure">5. Vault Infrastructure</a></h3>
<p>Deploy and configure HashiCorp Vault with AWS KMS encryption.</p>
<p><strong>Guidelines:</strong> <a href="./vault/index.html">HashiCorp Vault</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="trusted-ca-store-configuration"><a class="header" href="#trusted-ca-store-configuration">Trusted CA Store Configuration</a></h1>
<p>This guide explains how to configure the controller node to trust Proxmox’s self-signed certificate, which is essential for secure Terraform operations.</p>
<h2 id="overview-1"><a class="header" href="#overview-1">Overview</a></h2>
<p>Proxmox VE uses self-signed certificates by default, which causes TLS verification errors when Terraform attempts to connect to the Proxmox API. This configuration adds the Proxmox certificate to the system’s trusted CA store, enabling secure communication.</p>
<h2 id="prerequisites-3"><a class="header" href="#prerequisites-3">Prerequisites</a></h2>
<ul>
<li>Controller node running Ubuntu Server</li>
<li>Network access to your Proxmox server</li>
<li><code>openssl</code> package installed (usually pre-installed on Ubuntu)</li>
<li>Root or sudo privileges</li>
</ul>
<h2 id="configuration-steps"><a class="header" href="#configuration-steps">Configuration Steps</a></h2>
<h3 id="step-1-set-proxmox-server-ip"><a class="header" href="#step-1-set-proxmox-server-ip">Step 1: Set Proxmox Server IP</a></h3>
<p>First, export your Proxmox server IP address as an environment variable:</p>
<pre><code class="language-bash">export PROXMOX_IP="&lt;PROXMOX_IP&gt;"
</code></pre>
<p><strong>Replace <code>&lt;PROXMOX_IP&gt;</code> with your actual Proxmox server IP address.</strong></p>
<p>Example:</p>
<pre><code class="language-bash">export PROXMOX_IP="192.168.1.100"
</code></pre>
<h3 id="step-2-download-the-proxmox-certificate"><a class="header" href="#step-2-download-the-proxmox-certificate">Step 2: Download the Proxmox Certificate</a></h3>
<p>Download the Proxmox server’s certificate to your controller node:</p>
<pre><code class="language-bash">echo | \
  openssl s_client -connect ${PROXMOX_IP}:8006 -showcerts 2&gt;/dev/null | \
  openssl x509 -outform PEM &gt; proxmox.crt
</code></pre>
<h3 id="step-3-add-certificate-to-system-ca-store"><a class="header" href="#step-3-add-certificate-to-system-ca-store">Step 3: Add Certificate to System CA Store</a></h3>
<p>Copy the certificate to the system’s trusted CA certificates directory:</p>
<pre><code class="language-bash">sudo cp proxmox.crt /usr/local/share/ca-certificates/proxmox.crt
</code></pre>
<h3 id="step-4-update-trusted-ca-certificates"><a class="header" href="#step-4-update-trusted-ca-certificates">Step 4: Update Trusted CA Certificates</a></h3>
<p>Update the system’s trusted CA certificates:</p>
<pre><code class="language-bash">sudo update-ca-certificates
</code></pre>
<p>You should see output similar to:</p>
<pre><code>Updating certificates in /etc/ssl/certs...
1 added, 0 removed; done.
Running hooks in /etc/ca-certificates/update.d...
</code></pre>
<h3 id="step-5-verify-certificate-installation"><a class="header" href="#step-5-verify-certificate-installation">Step 5: Verify Certificate Installation</a></h3>
<p>Verify the certificate was successfully added:</p>
<pre><code class="language-bash">ls -la /usr/local/share/ca-certificates/proxmox.crt
</code></pre>
<p>The file should exist and be readable.</p>
<h3 id="step-6-clean-up"><a class="header" href="#step-6-clean-up">Step 6: Clean Up</a></h3>
<p>Remove the temporary certificate file:</p>
<pre><code class="language-bash">rm proxmox.crt

</code></pre>
<h2 id="verification"><a class="header" href="#verification">Verification</a></h2>
<p>To verify that the certificate is properly trusted, you can test the connection:</p>
<pre><code class="language-bash">curl -I https://${PROXMOX_IP}:8006/api2/json/version
</code></pre>
<p>This should return a successful HTTP response without certificate errors.</p>
<h2 id="alternative-configuration-less-secure"><a class="header" href="#alternative-configuration-less-secure">Alternative Configuration (Less Secure)</a></h2>
<p>If you prefer not to trust the certificate system-wide, you can configure Terraform to skip certificate verification by setting <code>insecure = true</code> in your Proxmox provider configuration:</p>
<pre><code class="language-hcl">provider "proxmox" {
  endpoint  = "your endpoint"
  
  username  = "your username"
  password  = var.user_terraform_password
  insecure  = true
}

</code></pre>
<p><strong>⚠️ Security Warning</strong>: Using <code>insecure = true</code> bypasses certificate verification and makes your connection vulnerable to man-in-the-middle attacks. The trusted CA store method is recommended for production environments.</p>
<h2 id="security-considerations-1"><a class="header" href="#security-considerations-1">Security Considerations</a></h2>
<ul>
<li>The certificate is added to the system-wide trusted CA store, affecting all applications on the controller node</li>
<li>This is the recommended approach for production environments</li>
<li>Consider certificate rotation if your Proxmox server’s certificate changes</li>
<li>Monitor for any security updates related to certificate handling</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="aws-backend-configuration"><a class="header" href="#aws-backend-configuration">AWS Backend Configuration</a></h1>
<h2 id="overview-2"><a class="header" href="#overview-2">Overview</a></h2>
<p>This section covers the AWS backend configuration required for our Proxmox homelab infrastructure. The AWS backend provides secure, scalable storage and encryption services that are essential for managing our infrastructure state and sensitive data.</p>
<h2 id="why-aws-backend-is-essential"><a class="header" href="#why-aws-backend-is-essential">Why AWS Backend is Essential</a></h2>
<p>Before deploying our Proxmox homelab infrastructure, we need to establish a secure AWS backend for several critical reasons:</p>
<h3 id="enhanced-security"><a class="header" href="#enhanced-security">Enhanced Security</a></h3>
<ul>
<li><strong>Encrypted State Storage</strong>: Terraform state files contain sensitive information including resource IDs, IP addresses, and configuration details. AWS S3 with server-side encryption ensures these secrets are protected at rest.</li>
<li><strong>KMS Key Management</strong>: AWS KMS provides centralized key management with automatic rotation, audit logging, and fine-grained access controls for encrypting/decrypting sensitive data.</li>
<li><strong>Access Control</strong>: IAM policies ensure only authorized users can access the backend resources, preventing unauthorized infrastructure modifications.</li>
</ul>
<h3 id="operational-benefits"><a class="header" href="#operational-benefits">Operational Benefits</a></h3>
<ul>
<li><strong>Remote State Management</strong>: Multiple team members can collaborate on infrastructure changes with consistent state locking.</li>
<li><strong>Backup and Recovery</strong>: Automated backups and point-in-time recovery capabilities for both Terraform state and Vault data.</li>
<li><strong>Cost Optimization</strong>: Pay-as-you-use model with lifecycle policies to automatically transition data to cheaper storage classes.</li>
</ul>
<h2 id="components"><a class="header" href="#components">Components</a></h2>
<p>The AWS backend for this project is split into two modules:</p>
<ul>
<li><a href="initial_setup/aws/./s3_backend.html">S3 Backend</a>: Remote Terraform state storage</li>
<li><a href="initial_setup/aws/./kms_backend.html">KMS Backend</a>: Encryption key management (auto-unseal, storage encryption)</li>
</ul>
<p>Use the S3 module first to create the remote state bucket, then configure the KMS module to use that bucket via <code>backend.config</code>.</p>
<h2 id="aws-authentication"><a class="header" href="#aws-authentication">AWS Authentication</a></h2>
<p>Authenticate with AWS using one of the following methods:</p>
<pre><code class="language-bash"># Environment variables (recommended)
export AWS_ACCESS_KEY_ID="&lt;access-key-id&gt;"
export AWS_SECRET_ACCESS_KEY="&lt;secret-access-key&gt;"
export AWS_DEFAULT_REGION="us-east-1"
</code></pre>
<pre><code class="language-ini"># ~/.aws/credentials (credentials file)
[default]
aws_access_key_id = &lt;access-key-id&gt;
aws_secret_access_key = &lt;secret-access-key&gt;
region = us-east-1
</code></pre>
<pre><code class="language-bash"># AWS named profile (example)
aws configure --profile proxmox-backend
export AWS_PROFILE=proxmox-backend
</code></pre>
<p>Verify credentials:</p>
<pre><code class="language-bash">aws sts get-caller-identity
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="s3-backend-terraform-state-storage"><a class="header" href="#s3-backend-terraform-state-storage">S3 Backend (Terraform State Storage)</a></h1>
<p>This module provisions the S3 bucket used as the remote backend for Terraform state across the project.</p>
<h2 id="prerequisites-4"><a class="header" href="#prerequisites-4">Prerequisites</a></h2>
<ul>
<li>An AWS account with permissions to create S3 buckets.</li>
<li>AWS authentication configured (see “AWS Backend Configuration” page for methods and verification).</li>
</ul>
<h2 id="configuration"><a class="header" href="#configuration">Configuration</a></h2>
<h3 id="module-location"><a class="header" href="#module-location">Module Location</a></h3>
<p><code>resources/aws/00_tf_s3_backend</code></p>
<h3 id="configure-variables"><a class="header" href="#configure-variables">Configure Variables</a></h3>
<p>Copy and edit variables:</p>
<pre><code class="language-bash">cd resources/aws/00_tf_s3_backend
cp terraform.tfvars.example terraform.tfvars
</code></pre>
<p>Set the following in <code>terraform.tfvars</code>:</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Type</th><th>Description</th><th>Example</th></tr></thead><tbody>
<tr><td><code>aws_region</code></td><td>string</td><td>AWS region for resources</td><td>“us-east-1”</td></tr>
<tr><td><code>s3_bucket_name</code></td><td>string</td><td>Name of the S3 bucket for Terraform backend</td><td>“terraform-backend-proxmox”</td></tr>
<tr><td><code>admin_users</code></td><td>list(string)</td><td>IAM principal ARNs with admin access to the S3 bucket</td><td>[“arn:aws:iam::<acct>:user/admin1”]</td></tr>
<tr><td><code>standard_users</code></td><td>list(string)</td><td>IAM principal ARNs with standard access to the S3 bucket</td><td>[“arn:aws:iam::<acct>:user/user1”]</td></tr>
</tbody></table>
</div>
<p>The lists <code>admin_users</code> and <code>standard_users</code> must each contain at least one ARN.</p>
<h2 id="deploy"><a class="header" href="#deploy">Deploy</a></h2>
<pre><code class="language-bash">terraform init
terraform plan
terraform apply
</code></pre>
<h2 id="outputs"><a class="header" href="#outputs">Outputs</a></h2>
<ul>
<li><code>s3_bucket_name</code>: The name of the S3 bucket for Terraform backend</li>
<li><code>s3_bucket_arn</code>: The ARN of the S3 bucket for Terraform backend</li>
<li><code>s3_bucket_domain_name</code>: The bucket domain name for Terraform backend</li>
</ul>
<h2 id="use-this-bucket-as-remote-backend"><a class="header" href="#use-this-bucket-as-remote-backend">Use This Bucket as Remote Backend</a></h2>
<p>Other modules (for example <code>resources/aws/01_kms</code>) read backend settings from a <code>backend.config</code> file. After the bucket is created, set its name in that file:</p>
<pre><code class="language-hcl"># resources/aws/01_kms/backend.config
bucket = "&lt;your-created-bucket-name&gt;"
region = "&lt;your-region&gt;"
</code></pre>
<p>Then initialize the downstream module with:</p>
<pre><code class="language-bash">terraform init -backend-config=backend.config
</code></pre>
<h2 id="cleanup"><a class="header" href="#cleanup">Cleanup</a></h2>
<p>To remove the backend bucket, ensure it is empty first (Terraform state files are stored here). Then:</p>
<pre><code class="language-bash">terraform destroy
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="kms-backend-encryption-key-management"><a class="header" href="#kms-backend-encryption-key-management">KMS Backend (Encryption Key Management)</a></h1>
<p>This module provisions an AWS KMS key and alias for encrypting sensitive data, such as Vault storage and other AWS services.</p>
<h2 id="prerequisites-5"><a class="header" href="#prerequisites-5">Prerequisites</a></h2>
<ul>
<li>S3 backend bucket created and available (see <a href="initial_setup/aws/s3_backend.html">S3 Backend</a> page).</li>
<li>AWS authentication configured (see “<a href="initial_setup/aws/index.html#aws-authentication">AWS Configuration</a>” page for methods and verification).</li>
</ul>
<h2 id="configuration-1"><a class="header" href="#configuration-1">Configuration</a></h2>
<h3 id="module-location-1"><a class="header" href="#module-location-1">Module Location</a></h3>
<p><code>resources/aws/01_kms</code></p>
<h3 id="configure-backend"><a class="header" href="#configure-backend">Configure Backend</a></h3>
<p>Copy the example backend config, then edit it:</p>
<pre><code class="language-bash">cp backend.config.example backend.config
</code></pre>
<p>Update <code>backend.config</code> to point to your S3 state bucket:</p>
<pre><code class="language-hcl">bucket = "&lt;your-created-bucket-name&gt;"
region = "&lt;your-region&gt;"
</code></pre>
<p>Initialize with:</p>
<pre><code class="language-bash">terraform init -backend-config=backend.config
</code></pre>
<h3 id="configure-variables-1"><a class="header" href="#configure-variables-1">Configure Variables</a></h3>
<p>Copy and edit variables:</p>
<pre><code class="language-bash">cp terraform.tfvars.example terraform.tfvars
</code></pre>
<p>Set the following in <code>terraform.tfvars</code>:</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Type</th><th>Description</th><th>Example</th></tr></thead><tbody>
<tr><td><code>kms_alias_name</code></td><td>string</td><td>Alias name for the KMS key</td><td>“vault-backend”</td></tr>
<tr><td><code>kms_key_description</code></td><td>string</td><td>Description for the KMS key</td><td>“KMS key for Vault backend encryption”</td></tr>
<tr><td><code>kms_key_deletion_window</code></td><td>number</td><td>Deletion window in days (7-30)</td><td>30</td></tr>
<tr><td><code>kms_key_rotation</code></td><td>bool</td><td>Enable automatic key rotation</td><td>true</td></tr>
<tr><td><code>admin_users</code></td><td>list(string)</td><td>IAM ARNs with full KMS permissions</td><td>[“arn:aws:iam::<acct>:user/admin1”]</td></tr>
<tr><td><code>standard_users</code></td><td>list(string)</td><td>IAM ARNs with encrypt/decrypt permissions</td><td>[“arn:aws:iam::<acct>:user/user1”]</td></tr>
</tbody></table>
</div>
<p>Validation rules enforce at least one admin and one standard user and that deletion window is between 7 and 30.</p>
<h2 id="deploy-1"><a class="header" href="#deploy-1">Deploy</a></h2>
<pre><code class="language-bash">terraform plan
terraform apply
</code></pre>
<h2 id="outputs-1"><a class="header" href="#outputs-1">Outputs</a></h2>
<ul>
<li><code>kms_key_id</code>: The globally unique identifier for the KMS key</li>
<li><code>kms_key_arn</code>: The Amazon Resource Name (ARN) of the KMS key</li>
<li><code>kms_key_alias_name</code>: The display name of the KMS key alias</li>
<li><code>kms_key_alias_arn</code>: The Amazon Resource Name (ARN) of the KMS key alias</li>
<li><code>kms_key_rotation_enabled</code>: Whether automatic key rotation is enabled</li>
<li><code>kms_key_deletion_window</code>: The deletion window in days</li>
</ul>
<h2 id="integration-examples"><a class="header" href="#integration-examples">Integration Examples</a></h2>
<ul>
<li>Use for S3 bucket default encryption.</li>
<li>Use as the KMS key for Vault storage auto-unseal and Transit engine.</li>
<li>Use with EBS, RDS, and other AWS services requiring KMS.</li>
</ul>
<h2 id="cleanup-1"><a class="header" href="#cleanup-1">Cleanup</a></h2>
<pre><code class="language-bash">terraform destroy
</code></pre>
<p>Note: KMS keys observe the configured deletion window and are not deleted immediately.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="proxmox-setup"><a class="header" href="#proxmox-setup">Proxmox Setup</a></h1>
<p>This section covers the essential Proxmox configuration and VM template setup for your homelab infrastructure.</p>
<h2 id="users-and-roles"><a class="header" href="#users-and-roles"><a href="initial_setup/proxmox_setup/./users_and_roles.html">Users and Roles</a></a></h2>
<p>Create dedicated automation users and custom roles for Terraform and Packer operations with appropriate permissions.</p>
<h2 id="local-storage"><a class="header" href="#local-storage"><a href="initial_setup/proxmox_setup/./local_storage.html">Local Storage</a></a></h2>
<p>Configure local storage for ISO images and container templates with automated downloads.</p>
<h2 id="base-vm-templates"><a class="header" href="#base-vm-templates"><a href="initial_setup/proxmox_setup/./vm_templates.html">Base VM Templates</a></a></h2>
<p>Pre-configured VM templates for rapid deployment with cloud-init integration.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="proxmox-users-and-roles-configuration"><a class="header" href="#proxmox-users-and-roles-configuration">Proxmox Users and Roles Configuration</a></h1>
<p>This configuration creates dedicated automation users and custom roles for Terraform and Packer operations on your Proxmox server. These components are essential for infrastructure automation and must be configured with appropriate permissions.</p>
<h2 id="prerequisites-6"><a class="header" href="#prerequisites-6">Prerequisites</a></h2>
<ul>
<li>Proxmox server is running and accessible</li>
<li>Terraform provider for Proxmox is configured</li>
<li>Administrative access to Proxmox server</li>
<li>Network connectivity between controller node and Proxmox server</li>
</ul>
<h2 id="configuration-2"><a class="header" href="#configuration-2">Configuration</a></h2>
<h3 id="module-location-2"><a class="header" href="#module-location-2">Module Location</a></h3>
<p><code>resources/proxmox/00_proxmox_administration/00_users_and_roles</code></p>
<h3 id="configure-backend-1"><a class="header" href="#configure-backend-1">Configure Backend</a></h3>
<p>Copy the example backend config, then edit it to point to your S3 state bucket:</p>
<pre><code class="language-bash">cp backend.config.example backend.config
</code></pre>
<pre><code class="language-hcl">bucket = "your-actual-s3-bucket-name"
region = "us-east-1"
</code></pre>
<h2 id="deploy-2"><a class="header" href="#deploy-2">Deploy</a></h2>
<pre><code class="language-bash">terraform init -backend-config=backend.config
terraform plan
terraform apply
</code></pre>
<h3 id="configure-variables-2"><a class="header" href="#configure-variables-2">Configure Variables</a></h3>
<p>The following variables will be prompted during deployment:</p>
<div class="table-wrapper"><table><thead><tr><th>Variable</th><th>Type</th><th>Description</th><th>Default</th><th>Required</th></tr></thead><tbody>
<tr><td><code>proxmox_endpoint</code></td><td>string</td><td>The URL of the Proxmox endpoint (Format: https://proxmox-host-ip:8006)</td><td></td><td>Yes</td></tr>
<tr><td><code>s3_bucket</code></td><td>string</td><td>Name of the S3 bucket used as Terraform backend</td><td>-</td><td>Yes</td></tr>
<tr><td><code>virtual_environment_username</code></td><td>string</td><td>Username (with realm) for Proxmox authentication</td><td>-</td><td>Yes</td></tr>
<tr><td><code>virtual_environment_password</code></td><td>string</td><td>Password for Proxmox authentication</td><td>-</td><td>Yes</td></tr>
<tr><td><code>user_initial_password</code></td><td>string</td><td>Initial password for created users</td><td>-</td><td>Yes</td></tr>
</tbody></table>
</div>
<h2 id="created-users"><a class="header" href="#created-users">Created Users</a></h2>
<h3 id="terraform-pve-user-terraformpve"><a class="header" href="#terraform-pve-user-terraformpve">Terraform PVE User (<code>terraform@pve</code>)</a></h3>
<p><strong>Purpose</strong>: Primary automation user for Terraform operations</p>
<p><strong>Permissions</strong>:</p>
<ul>
<li><strong>VM Management</strong>: Full administrative access to <code>/vms</code> path with <code>PVEVMAdmin</code> role</li>
<li><strong>Storage Management</strong>: Administrative access to <code>/storage</code> path with <code>PVEDatastoreAdmin</code> role</li>
<li><strong>SDN Management</strong>: Administrative access to <code>/sdn</code> path with <code>PVESDNAdmin</code> role</li>
<li><strong>System Audit</strong>: System modification and audit permissions with <code>SysModifyAudit</code> role</li>
</ul>
<p><strong>Groups</strong>: Standard</p>
<h2 id="created-roles"><a class="header" href="#created-roles">Created Roles</a></h2>
<h3 id="sysmodifyaudit-role"><a class="header" href="#sysmodifyaudit-role">SysModifyAudit Role</a></h3>
<p><strong>Role ID</strong>: <code>SysModifyAudit</code></p>
<p><strong>Purpose</strong>: Provides system modification and audit capabilities for automation users</p>
<p><strong>Privileges</strong>:</p>
<ul>
<li><strong>Sys.Audit</strong>: System audit permissions for monitoring and logging</li>
<li><strong>Sys.Modify</strong>: System modification permissions for infrastructure changes</li>
</ul>
<p><strong>Usage</strong>: This role is assigned to the <code>terraform@pve</code> user to provide necessary permissions for:</p>
<ul>
<li>System configuration changes</li>
<li>Audit trail maintenance</li>
<li>Infrastructure monitoring</li>
<li>Automated system modifications</li>
</ul>
<h2 id="post-deployment"><a class="header" href="#post-deployment">Post-deployment</a></h2>
<h3 id="generate-api-token"><a class="header" href="#generate-api-token">Generate API Token</a></h3>
<p>After the users and roles are created, you need to generate API tokens for the automation users to use with Terraform and Packer.</p>
<h4 id="for-terraform-user-terraformpve"><a class="header" href="#for-terraform-user-terraformpve">For Terraform User (<code>terraform@pve</code>)</a></h4>
<ol>
<li>
<p><strong>Access Proxmox Web Interface</strong></p>
<ul>
<li>Navigate to your Proxmox server web interface (typically <code>https://your-proxmox-ip:8006</code>)</li>
<li>Log in with your administrative credentials</li>
</ul>
</li>
<li>
<p><strong>Navigate to User Management</strong></p>
<ul>
<li>Go to <strong>Datacenter</strong> → <strong>Permissions</strong> → <strong>API Tokens</strong></li>
<li>Click on <code>Add</code></li>
</ul>
</li>
<li>
<p><strong>Token Configuration</strong></p>
<ul>
<li>Configure the token:
<ul>
<li><strong>User</strong>: Choose <code>terraform@pve</code></li>
<li><strong>Token ID</strong>: <code>deployment-token</code> (or your preferred name)</li>
<li><strong>Privilege Separation</strong>: Leave unchecked (token inherits user permissions)</li>
<li><strong>Expiration</strong>: Set according to your security policy (optional)</li>
<li><strong>Comment</strong>: Input your comment here (optional)</li>
</ul>
</li>
<li>Click <strong>“Generate”</strong></li>
</ul>
</li>
<li>
<p><strong>Save Token Credentials</strong></p>
<ul>
<li><strong>Important</strong>: Copy and securely store the generated token</li>
<li>The token will be displayed as: <code>terraform@pve!terraform-token=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx</code></li>
<li>This token will be used in your Terraform provider configuration</li>
</ul>
</li>
</ol>
<p><img src="initial_setup/proxmox_setup/./api_token.png" alt="Proxmox API Token Example" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="proxmox-local-storage-configuration"><a class="header" href="#proxmox-local-storage-configuration">Proxmox Local Storage Configuration</a></h1>
<p>This configuration sets up local storage for ISO images and container templates on your Proxmox server. It includes automated downloads of Ubuntu server images and Debian container templates, providing the foundation for VM and container creation.</p>
<h2 id="prerequisites-7"><a class="header" href="#prerequisites-7">Prerequisites</a></h2>
<ul>
<li>Proxmox server is running and accessible</li>
<li>Terraform provider for Proxmox is configured</li>
<li>Administrative access to Proxmox server</li>
<li>Users and roles configuration completed (see <a href="initial_setup/proxmox_setup/./users.html">Users</a> and <a href="initial_setup/proxmox_setup/./roles.html">Roles</a>)</li>
<li>Sufficient disk space for ISO images and templates</li>
<li>Network connectivity for downloading images</li>
</ul>
<blockquote>
<p><strong>Important</strong>: Ensure you have completed the Users and Roles configuration before proceeding with local storage setup. The terraform user created in the previous steps will be used for automated operations.</p>
</blockquote>
<h2 id="configuration-3"><a class="header" href="#configuration-3">Configuration</a></h2>
<h3 id="module-location-3"><a class="header" href="#module-location-3">Module Location</a></h3>
<p><code>resources/proxmox/00_proxmox_administration/01_local_storage</code></p>
<h3 id="configure-backend-2"><a class="header" href="#configure-backend-2">Configure Backend</a></h3>
<p>Copy the backend configuration example and update the values:</p>
<pre><code class="language-bash">cp backend.config.example backend.config
</code></pre>
<p>Edit <code>backend.config</code> and update the S3 bucket name:</p>
<pre><code class="language-hcl">bucket = "your-actual-s3-bucket-name"
region = "us-east-1"
</code></pre>
<h3 id="configure-variables-3"><a class="header" href="#configure-variables-3">Configure Variables</a></h3>
<p>The following variables will be prompted during deployment:</p>
<div class="table-wrapper"><table><thead><tr><th>Variable</th><th>Type</th><th>Description</th><th>Default</th><th>Required</th></tr></thead><tbody>
<tr><td><code>proxmox_endpoint</code></td><td>string</td><td>The URL of the Proxmox endpoint</td><td><code>"https://192.168.1.100:8006"</code></td><td>No</td></tr>
<tr><td><code>user_terraform_password</code></td><td>string</td><td>Password for terraform user authentication</td><td>-</td><td>Yes</td></tr>
<tr><td><code>node_name</code></td><td>string</td><td>Node name to deploy resources</td><td><code>"pve"</code></td><td>No</td></tr>
<tr><td><code>data_store_id</code></td><td>string</td><td>Data store ID for storage</td><td><code>"local"</code></td><td>No</td></tr>
</tbody></table>
</div>
<h2 id="deploy-3"><a class="header" href="#deploy-3">Deploy</a></h2>
<pre><code class="language-bash">terraform init -backend-config="./backend.config"
terraform plan
terraform apply
</code></pre>
<blockquote>
<p><strong>Note</strong>: From this step, use the <code>terraform@pve</code> user for automation instead of the standard user. This user has the necessary permissions for automated operations and follows security best practices.</p>
</blockquote>
<h2 id="storage-configuration"><a class="header" href="#storage-configuration">Storage Configuration</a></h2>
<h3 id="local-storage-setup"><a class="header" href="#local-storage-setup">Local Storage Setup</a></h3>
<p><strong>Storage ID</strong>: <code>local</code> (default)
<strong>Node</strong>: <code>pve</code> (default)
<strong>Type</strong>: Local storage for ISOs and templates</p>
<h3 id="storage-requirements"><a class="header" href="#storage-requirements">Storage Requirements</a></h3>
<p><strong>Minimum Space Requirements</strong>:</p>
<ul>
<li>Ubuntu ISO: ~1.5 GB</li>
<li>Debian Template: ~200 MB</li>
<li><strong>Total</strong>: ~2 GB minimum</li>
</ul>
<p><strong>Recommended Space</strong>:</p>
<ul>
<li><strong>Minimum</strong>: 5 GB for current downloads</li>
<li><strong>Recommended</strong>: 10 GB for future templates and ISOs</li>
<li><strong>Production</strong>: 20+ GB for multiple OS versions</li>
</ul>
<blockquote>
<p><strong>Tip</strong>: Consider using a dedicated storage pool for templates and ISOs to avoid filling up your main storage. This also makes it easier to manage and backup your template library.</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="guidelines"><a class="header" href="#guidelines">Guidelines</a></h1>
<ol>
<li>Choose your desired template from the list below</li>
<li>Follow the template-specific documentation</li>
<li>Build the template using Packer</li>
<li>Deploy VMs from the created template</li>
</ol>
<h1 id="vm-templates"><a class="header" href="#vm-templates">VM Templates</a></h1>
<p>Pre-configured VM templates for rapid deployment with cloud-init integration.</p>
<h3 id="ubuntu-server-2204-lts-jammy"><a class="header" href="#ubuntu-server-2204-lts-jammy"><a href="initial_setup/proxmox_setup/./base_vm_template_ubuntu_server.html">Ubuntu Server 22.04 LTS (Jammy)</a></a></h3>
<p>Ubuntu Server template with cloud-init support for automated configuration.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="proxmox-base-vm-template---ubuntu-server-2204-lts-jammy"><a class="header" href="#proxmox-base-vm-template---ubuntu-server-2204-lts-jammy">Proxmox Base VM Template - Ubuntu Server 22.04 LTS (Jammy)</a></h1>
<h2 id="overview-3"><a class="header" href="#overview-3">Overview</a></h2>
<p>This configuration creates a standardized Ubuntu Server 22.04 LTS (Jammy) VM template for Proxmox using Packer. The template is optimized for cloud-init integration and provides a consistent foundation for VM deployments across your Proxmox homelab environment.</p>
<h2 id="prerequisites-8"><a class="header" href="#prerequisites-8">Prerequisites</a></h2>
<ul>
<li>Proxmox server is running and accessible</li>
<li>Packer is installed on your build machine</li>
<li>Proxmox API token with appropriate permissions</li>
<li>SSH key pair for authentication</li>
<li>Sufficient disk space on Proxmox node (minimum 20GB)</li>
<li>Network connectivity between build machine and Proxmox server</li>
</ul>
<h2 id="vm-specifications"><a class="header" href="#vm-specifications">VM Specifications</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Component</th><th>Specification</th></tr></thead><tbody>
<tr><td><strong>OS</strong></td><td>Ubuntu Server 22.04 LTS (Jammy)</td></tr>
<tr><td><strong>CPU</strong></td><td>4 cores</td></tr>
<tr><td><strong>Memory</strong></td><td>4 GB</td></tr>
<tr><td><strong>Disk</strong></td><td>20 GB (virtio)</td></tr>
<tr><td><strong>Network</strong></td><td>virtio (vmbr0)</td></tr>
<tr><td><strong>Storage Pool</strong></td><td>local-lvm</td></tr>
<tr><td><strong>VM ID</strong></td><td>1000 (configurable)</td></tr>
</tbody></table>
</div>
<h2 id="configuration-4"><a class="header" href="#configuration-4">Configuration</a></h2>
<h3 id="module-location-4"><a class="header" href="#module-location-4">Module Location</a></h3>
<pre><code class="language-bash">resources/proxmox/01_base_vm_template/ubuntu_server_jammy
</code></pre>
<h3 id="files"><a class="header" href="#files">Files</a></h3>
<p><code>build.pkr.hcl</code> - Build Definition
The main build configuration that defines:</p>
<ul>
<li><strong>Build name</strong>: <code>ubuntu-server-jammy</code></li>
<li><strong>Source reference</strong>: Links to the Proxmox source configuration</li>
<li><strong>Provisioning steps</strong>: Shell commands for VM preparation</li>
<li><strong>File provisioning</strong>: Cloud-init configuration files</li>
<li><strong>Template optimization</strong>: Removes machine-specific data for templating</li>
</ul>
<p><code>sources.pkr.hcl</code> - Source Configuration
Defines the Proxmox VM source with:</p>
<ul>
<li><strong>Connection settings</strong>: Proxmox API URL, authentication</li>
<li><strong>VM specifications</strong>: CPU, memory, disk, network settings</li>
<li><strong>ISO configuration</strong>: Ubuntu Server 22.04 LTS installation</li>
<li><strong>Cloud-init setup</strong>: Automated installation and configuration</li>
<li><strong>Boot commands</strong>: Automated installation parameters</li>
</ul>
<p><code>variables.pkr.hcl</code> - Variable Definitions
Contains configurable parameters:</p>
<ul>
<li><strong>Proxmox connection</strong>: Host IP, API tokens, SSH credentials</li>
<li><strong>VM settings</strong>: Node name, VM ID, storage pools</li>
<li><strong>Validation rules</strong>: Input validation for security and correctness</li>
</ul>
<h3 id="set-environment-variables"><a class="header" href="#set-environment-variables">Set Environment Variables</a></h3>
<p>Configure the required environment variables for Packer:</p>
<div class="table-wrapper"><table><thead><tr><th>Variable</th><th>Description</th><th>Type</th><th>Default</th><th>Required</th></tr></thead><tbody>
<tr><td><code>proxmox_host_ip</code></td><td>Proxmox server URL</td><td><code>string</code></td><td><code>env("PROXMOX_HOST_IP")</code></td><td>Yes</td></tr>
<tr><td><code>proxmox_api_token_id</code></td><td>API token ID</td><td><code>string</code></td><td><code>env("PROXMOX_API_TOKEN_ID")</code></td><td>Yes</td></tr>
<tr><td><code>proxmox_api_token_secret</code></td><td>API token secret</td><td><code>string</code></td><td><code>env("PROXMOX_API_TOKEN_SECRET")</code></td><td>Yes</td></tr>
<tr><td><code>ssh_username</code></td><td>SSH username for build</td><td><code>string</code></td><td><code>env("SSH_USERNAME")</code></td><td>Yes</td></tr>
<tr><td><code>ssh_public_key</code></td><td>Public key used to authorize users to the VM</td><td><code>string</code></td><td><code>env("SSH_PUBLIC_KEY")</code></td><td>Yes</td></tr>
<tr><td><code>vm_id</code></td><td>VM ID for the template (1000-1999)</td><td><code>number</code></td><td><code>env("VM_ID")</code></td><td>No</td></tr>
</tbody></table>
</div>
<p>As those variables refer values from environment variables value, we can set it directly from command line. For example:</p>
<pre><code class="language-bash"># Proxmox Connection
export PROXMOX_HOST_IP="https://192.168.1.100"
export PROXMOX_API_TOKEN_ID='terraform@pve!deployment-token'
export PROXMOX_API_TOKEN_SECRET="your-token-secret"
export SSH_USERNAME="your-ssh-user"
export SSH_PUBLIC_KEY=$(cat ~/.ssh/id_rsa.pub)
export PKR_VAR_vm_id=1000
</code></pre>
<blockquote>
<p><strong>Note</strong>: The SSH public key path can vary depending on your key type and location:</p>
<ul>
<li><strong>RSA keys</strong>: <code>~/.ssh/id_rsa.pub</code></li>
<li><strong>ED25519 keys</strong>: <code>~/.ssh/id_ed25519.pub</code> (recommended)</li>
<li><strong>ECDSA keys</strong>: <code>~/.ssh/id_ecdsa.pub</code></li>
<li><strong>Custom location</strong>: Use the full path to your public key file</li>
</ul>
</blockquote>
<h3 id="customize-configuration-optional"><a class="header" href="#customize-configuration-optional">Customize Configuration (Optional)</a></h3>
<p>Edit the following files as needed:</p>
<p><strong><code>http/user-data.tpl</code></strong> - Cloud-init user configuration:</p>
<ul>
<li>Update user information</li>
<li>Modify SSH keys</li>
<li>Adjust timezone settings</li>
<li>Add/remove packages</li>
</ul>
<p><strong><code>files/99-pve.cfg</code></strong> - Proxmox-specific cloud-init settings:</p>
<ul>
<li>Configure datasource for Proxmox integration</li>
</ul>
<h3 id="build-the-template"><a class="header" href="#build-the-template">Build the Template</a></h3>
<p>Before building, validate your configuration to ensure everything is properly configured:</p>
<pre><code class="language-bash">packer validate .
</code></pre>
<p>If validation passes, run Packer to build the VM template:</p>
<pre><code class="language-bash">packer build .
</code></pre>
<p>To update image, you can run build with <code>-force</code> argument:</p>
<pre><code class="language-bash">packer build -force .
</code></pre>
<p>For more information about using variables with Packer, see the <a href="https://developer.hashicorp.com/packer/docs/commands/build">Packer build command documentation</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="hashicorp-vault-infrastructure"><a class="header" href="#hashicorp-vault-infrastructure">HashiCorp Vault Infrastructure</a></h1>
<h2 id="overview-4"><a class="header" href="#overview-4">Overview</a></h2>
<p>This section covers the complete HashiCorp Vault infrastructure setup on Proxmox, including image building, server deployment, and component configuration. Vault provides secure secret management for your homelab environment.</p>
<h2 id="components-1"><a class="header" href="#components-1">Components</a></h2>
<h3 id="vault-image-builder"><a class="header" href="#vault-image-builder"><strong>Vault Image Builder</strong></a></h3>
<p>Creates a custom Vault server image using Packer with KMS encryption support.</p>
<h3 id="vault-server"><a class="header" href="#vault-server"><strong>Vault Server</strong></a></h3>
<p>Deploys the Vault server using Terraform with secure configuration.</p>
<h3 id="vault-components"><a class="header" href="#vault-components"><strong>Vault Components</strong></a></h3>
<p>Configures Vault with authentication methods, policies, and secrets engines.</p>
<h2 id="prerequisites-9"><a class="header" href="#prerequisites-9">Prerequisites</a></h2>
<ul>
<li>Proxmox server running and accessible</li>
<li>Packer installed for image building</li>
<li>Terraform installed for infrastructure deployment</li>
<li>AWS KMS key for Vault encryption</li>
<li>Environment variables configured</li>
</ul>
<h2 id="quick-start"><a class="header" href="#quick-start">Quick Start</a></h2>
<ol>
<li><strong>Build Vault Image</strong> - Create custom Vault server template</li>
<li><strong>Deploy Vault Server</strong> - Deploy Vault server to Proxmox</li>
<li><strong>Configure Components</strong> - Set up authentication and secrets</li>
</ol>
<h2 id="security-features"><a class="header" href="#security-features">Security Features</a></h2>
<ul>
<li><strong>KMS Encryption</strong>: AWS KMS integration for secure key management</li>
<li><strong>TLS Communication</strong>: Encrypted communication with client certificates</li>
<li><strong>Access Control</strong>: Role-based access control and policies</li>
<li><strong>Secret Management</strong>: Secure storage and retrieval of sensitive data</li>
</ul>
<h2 id="next-steps-1"><a class="header" href="#next-steps-1">Next Steps</a></h2>
<ul>
<li><a href="initial_setup/vault/vault_image.html">Vault Image Builder</a> - Create custom Vault server image</li>
<li><a href="initial_setup/vault/vault_server.html">Vault Server Deployment</a> - Deploy Vault server to Proxmox</li>
<li><a href="initial_setup/vault/vault_components.html">Vault Components Setup</a> - Configure Vault authentication and policies</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="vault-image-builder-1"><a class="header" href="#vault-image-builder-1">Vault Image Builder</a></h1>
<h2 id="overview-5"><a class="header" href="#overview-5">Overview</a></h2>
<p>Creates a custom HashiCorp Vault server image for Proxmox using Packer. The image includes Vault pre-installed with KMS encryption support and systemd service configuration.</p>
<h2 id="prerequisites-10"><a class="header" href="#prerequisites-10">Prerequisites</a></h2>
<ul>
<li>Packer installed</li>
<li>Proxmox server accessible</li>
<li><a href="initial_setup/vault/../vm_templates/index.html">VM Templates</a> setup completed</li>
<li><a href="initial_setup/vault/../proxmox_administration/index.html">Proxmox Administration</a> setup completed</li>
<li><a href="initial_setup/vault/../controller/trusted_ca_store.html">Trusted CA Store</a> configuration completed</li>
</ul>
<h2 id="vm-specifications-1"><a class="header" href="#vm-specifications-1">VM Specifications</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Component</th><th>Specification</th></tr></thead><tbody>
<tr><td><strong>Base Template</strong></td><td>Ubuntu Server 22.04 LTS (Jammy)</td></tr>
<tr><td><strong>CPU</strong></td><td>2 cores</td></tr>
<tr><td><strong>Memory</strong></td><td>2 GB</td></tr>
<tr><td><strong>Disk</strong></td><td>20 GB (virtio)</td></tr>
<tr><td><strong>Network</strong></td><td>virtio (vmbr0)</td></tr>
<tr><td><strong>Storage Pool</strong></td><td>local-lvm</td></tr>
</tbody></table>
</div>
<h2 id="configuration-5"><a class="header" href="#configuration-5">Configuration</a></h2>
<h3 id="module-location-5"><a class="header" href="#module-location-5">Module Location</a></h3>
<pre><code class="language-bash">resources/proxmox/02_vault/00_vault_image
</code></pre>
<h3 id="files-1"><a class="header" href="#files-1">Files</a></h3>
<p><strong><code>build.pkr.hcl</code></strong> - Build Definition</p>
<ul>
<li>Defines the build process and provisioning steps</li>
<li>Configures Vault installation and service setup</li>
</ul>
<p><strong><code>sources.pkr.hcl</code></strong> - Source Configuration</p>
<ul>
<li>Proxmox VM source configuration</li>
<li>Hardware specifications and network settings</li>
<li>Cloud-init integration</li>
</ul>
<p><strong><code>variables.pkr.hcl</code></strong> - Variable Definitions</p>
<ul>
<li>Configurable parameters for the build</li>
<li>Validation rules for input parameters</li>
</ul>
<h3 id="set-environment-variables-1"><a class="header" href="#set-environment-variables-1">Set Environment Variables</a></h3>
<p>Configure the required environment variables for Packer:</p>
<div class="table-wrapper"><table><thead><tr><th>Variable</th><th>Description</th><th>Type</th><th>Default</th><th>Required</th></tr></thead><tbody>
<tr><td><code>proxmox_host_ip</code></td><td>IP address of Proxmox host</td><td><code>string</code></td><td><code>"https://192.168.1.100"</code></td><td>No</td></tr>
<tr><td><code>proxmox_api_token_id</code></td><td>API token ID in format <code>user@realm!tokenname</code></td><td><code>string</code></td><td>-</td><td>Yes</td></tr>
<tr><td><code>proxmox_api_token_secret</code></td><td>API token secret for Proxmox authentication</td><td><code>string</code></td><td>-</td><td>Yes</td></tr>
<tr><td><code>vm_id</code></td><td>VM ID for the template ((should range between 1000 and 1999))</td><td><code>number</code></td><td>-</td><td>Yes</td></tr>
<tr><td><code>vm_name</code></td><td>Name of the Vault template</td><td><code>string</code></td><td>-</td><td>Yes</td></tr>
<tr><td><code>vm_ip</code></td><td>IP address for the Vault VM</td><td><code>string</code></td><td>-</td><td>Yes</td></tr>
<tr><td><code>ssh_username</code></td><td>SSH username for build</td><td><code>string</code></td><td>-</td><td>Yes</td></tr>
<tr><td><code>vault_version</code></td><td>Vault version to install</td><td><code>string</code></td><td><code>"1.20.4"</code></td><td>No</td></tr>
<tr><td><code>vault_cluster_name</code></td><td>Name of the Vault cluster</td><td><code>string</code></td><td><code>"my-vault"</code></td><td>No</td></tr>
<tr><td><code>vault_storage_node_id</code></td><td>Storage node ID for Vault</td><td><code>string</code></td><td><code>"vault-server"</code></td><td>No</td></tr>
<tr><td><code>kms_key_id</code></td><td>AWS KMS key ID for Vault encryption</td><td><code>string</code></td><td>-</td><td>Yes</td></tr>
<tr><td><code>aws_access_key_id</code></td><td>AWS access key for KMS operations</td><td><code>string</code></td><td>-</td><td>Yes</td></tr>
<tr><td><code>aws_secret_access_key</code></td><td>AWS secret key for KMS operations</td><td><code>string</code></td><td>-</td><td>Yes</td></tr>
<tr><td><code>aws_region</code></td><td>AWS region for KMS operations</td><td><code>string</code></td><td><code>"us-east-1"</code></td><td>No</td></tr>
<tr><td><code>tls_allowed_ips</code></td><td>Comma-separated list of IP addresses for TLS certificate</td><td><code>string</code></td><td>-</td><td>Yes</td></tr>
</tbody></table>
</div>
<p>Set the required Packer variables using the <code>PKR_VAR_</code> prefix, for example:</p>
<pre><code class="language-bash"># Packer Variables
export PKR_VAR_proxmox_host_ip="https://192.168.1.100"
export PKR_VAR_proxmox_api_token_id='terraform@pve!deployment-token'
export PKR_VAR_proxmox_api_token_secret="your-token-secret"
export PKR_VAR_vm_id=1002
export PKR_VAR_vm_name="vault-template"
export PKR_VAR_vm_ip="192.168.1.3"
export PKR_VAR_ssh_username="ubuntu"
export PKR_VAR_vault_cluster_name="my-vault"
export PKR_VAR_vault_storage_node_id="vault-server"
export PKR_VAR_kms_key_id="12345678-abcd-1234-abcd-123456789101"
export PKR_VAR_aws_access_key_id="your-aws-access-key"
export PKR_VAR_aws_secret_access_key="your-aws-secret-key"
export PKR_VAR_aws_region="us-east-1"
export PKR_VAR_tls_allowed_ips="127.0.0.1,192.168.1.3"
</code></pre>
<h3 id="build-the-image"><a class="header" href="#build-the-image">Build the Image</a></h3>
<p>Before building, validate your configuration:</p>
<pre><code class="language-bash">packer validate .
</code></pre>
<p>If validation passes, run Packer to build the Vault image:</p>
<pre><code class="language-bash">packer build .
</code></pre>
<p>To update image, you can run build with <code>-force</code> argument:</p>
<pre><code class="language-bash">packer build -force .
</code></pre>
<h2 id="post-deployment-1"><a class="header" href="#post-deployment-1">Post Deployment</a></h2>
<h3 id="client-certificate-management"><a class="header" href="#client-certificate-management">Client Certificate Management</a></h3>
<p>After successful deployment, a <strong><code>client.pem</code></strong> file will be created in the <code>downloads/</code> folder. This certificate is essential for secure communication with your Vault server and should be moved to a secure location immediately.</p>
<p><strong>Purpose of the client certificate:</strong></p>
<ul>
<li>Enables secure TLS communication with the Vault server</li>
<li>Required for authenticated API access to Vault</li>
<li>Provides client authentication for encrypted connections</li>
<li>Essential for future Vault operations and management</li>
</ul>
<p><strong>Security Recommendations:</strong></p>
<ol>
<li>Move <code>client.pem</code> to a secure location outside the downloads folder</li>
<li>Store in encrypted storage or secure key management system</li>
<li>Set appropriate file permissions (600) to restrict access</li>
<li>Keep backup copies in separate secure locations</li>
<li>Never commit certificate files to version control</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="vault-server-deployment"><a class="header" href="#vault-server-deployment">Vault Server Deployment</a></h1>
<h2 id="overview-6"><a class="header" href="#overview-6">Overview</a></h2>
<p>Deploys the HashiCorp Vault server using the custom image created in the previous step. This creates a production-ready Vault server with secure configuration and client certificate generation.</p>
<h2 id="prerequisites-11"><a class="header" href="#prerequisites-11">Prerequisites</a></h2>
<ul>
<li><a href="initial_setup/vault/./vault_image.html">Vault image</a> created in previous step</li>
<li>Terraform installed</li>
<li>Environment variables configured</li>
<li>Proxmox server accessible</li>
</ul>
<h2 id="configuration-6"><a class="header" href="#configuration-6">Configuration</a></h2>
<h3 id="module-location-6"><a class="header" href="#module-location-6">Module Location</a></h3>
<pre><code class="language-bash">resources/proxmox/02_vault/01_vault_server
</code></pre>
<h3 id="configure-backend-3"><a class="header" href="#configure-backend-3">Configure Backend</a></h3>
<p>Copy the backend configuration example and update the values:</p>
<pre><code class="language-bash">cp backend.config.example backend.config
</code></pre>
<p>Edit <code>backend.config</code> and update the S3 bucket name:</p>
<pre><code class="language-hcl">bucket = "your-actual-s3-bucket-name"
region = "us-east-1"
</code></pre>
<h3 id="deploy-vault-server"><a class="header" href="#deploy-vault-server">Deploy Vault Server</a></h3>
<pre><code class="language-bash">terraform init -backend-config="./backend.config"
terraform plan
terraform apply
</code></pre>
<h3 id="configure-variables-4"><a class="header" href="#configure-variables-4">Configure Variables</a></h3>
<p>The following variables will be prompted during deployment:</p>
<div class="table-wrapper"><table><thead><tr><th>Variable</th><th>Type</th><th>Description</th><th>Default</th><th>Required</th></tr></thead><tbody>
<tr><td><code>proxmox_endpoint</code></td><td>string</td><td>The URL of the Proxmox endpoint (Format: https://proxmox-host-ip:8006)</td><td></td><td>Yes</td></tr>
<tr><td><code>user_terraform_password</code></td><td>string</td><td>Password to login as terraform@pve user for deployment</td><td></td><td>Yes</td></tr>
<tr><td><code>vm_source_template_id</code></td><td>number</td><td>The ID of VM template to be cloned from</td><td></td><td>Yes</td></tr>
<tr><td><code>vm_id</code></td><td>number</td><td>ID of the VM (Please use range from 2000 to 3999)</td><td></td><td>Yes</td></tr>
<tr><td><code>vm_ip</code></td><td>string</td><td>Static IP address for the VM (Example: 192.168.1.3)</td><td></td><td>Yes</td></tr>
<tr><td><code>vm_username</code></td><td>string</td><td>Username to login to VM</td><td></td><td>Yes</td></tr>
<tr><td><code>vm_password</code></td><td>string</td><td>Password to login to VM</td><td></td><td>Yes</td></tr>
</tbody></table>
</div>
<blockquote>
<p><strong>Note:</strong> Besides the variables listed above, you can customize additional VM settings (CPU cores, memory, disk size, etc.) by editing the <code>variables.tf</code> file directly for advanced configuration.</p>
</blockquote>
<h2 id="server-configuration"><a class="header" href="#server-configuration">Server Configuration</a></h2>
<h3 id="vm-specifications-2"><a class="header" href="#vm-specifications-2"><strong>VM Specifications</strong></a></h3>
<ul>
<li><strong>CPU</strong>: 2 cores</li>
<li><strong>Memory</strong>: 4 GB</li>
<li><strong>Disk</strong>: 20 GB</li>
<li><strong>Network</strong>: Bridge connection</li>
<li><strong>Template</strong>: Custom Vault image</li>
</ul>
<h3 id="security-features-1"><a class="header" href="#security-features-1"><strong>Security Features</strong></a></h3>
<ul>
<li><strong>TLS Encryption</strong>: HTTPS communication enabled</li>
<li><strong>Client Certificates</strong>: Secure certificate-based authentication</li>
<li><strong>KMS Integration</strong>: AWS KMS for key management</li>
<li><strong>Firewall Rules</strong>: Restricted network access</li>
</ul>
<h2 id="post-deployment-2"><a class="header" href="#post-deployment-2">Post-Deployment</a></h2>
<ol start="3">
<li><strong>Download vault_init_output.txt</strong>:
<ul>
<li>Copy the content from <code>vault_init_output.txt</code> to a secure location</li>
<li>This file contains the <strong>root token</strong> and <strong>unseal keys</strong></li>
<li>The root token is used to authenticate as the root user in Vault</li>
<li>Move and store this file into a more secured location as it provides full administrative access</li>
</ul>
</li>
</ol>
<p>After deployment, we can access the Vault UI at <code>https://&lt;ip&gt;:8200</code>. Enter the root token for first time login!</p>
<p><img src="initial_setup/vault/./images/vault_login.png" alt="Vault UI Login Screen" /></p>
<p>Once login successfully, we should see a dashboard as below. Congrats! We’re now ready to use Hashicorp Vault for further steps!
<img src="initial_setup/vault/./images/vault_dashboard.png" alt="Vault UI Dashboard" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="vault-components-setup"><a class="header" href="#vault-components-setup">Vault Components Setup</a></h1>
<h2 id="overview-7"><a class="header" href="#overview-7">Overview</a></h2>
<p>Configures HashiCorp Vault with authentication methods, policies, and secrets engines. This step establishes secure access control and prepares Vault for secret management operations.</p>
<h2 id="prerequisites-12"><a class="header" href="#prerequisites-12">Prerequisites</a></h2>
<ul>
<li><a href="initial_setup/vault/./vault_server.html">Vault server</a> deployed and accessible</li>
<li>Client certificate downloaded</li>
<li>Root token available</li>
<li>Terraform installed</li>
</ul>
<h2 id="configuration-7"><a class="header" href="#configuration-7">Configuration</a></h2>
<h3 id="module-location-7"><a class="header" href="#module-location-7">Module Location</a></h3>
<pre><code class="language-bash">resources/proxmox/02_vault/02_vault_components
</code></pre>
<h3 id="set-vault-environment-variables"><a class="header" href="#set-vault-environment-variables">Set Vault Environment Variables</a></h3>
<p>Configure Vault connection using the client certificate from the <a href="initial_setup/vault/./vault_image.html#post-deployment">Vault Image</a> and the token generated from the <a href="initial_setup/vault/./vault_server.html#post-deployment">Vault Server Deployment</a> step:</p>
<pre><code class="language-bash">export VAULT_TOKEN="hvs...."
export VAULT_ADDR="https://&lt;vm-ip&gt;:8200"
export VAULT_CACERT="&lt;path-to-client.pem&gt;"
</code></pre>
<h3 id="deploy-vault-components"><a class="header" href="#deploy-vault-components">Deploy Vault Components</a></h3>
<pre><code class="language-bash">terraform init -backend-config="./backend.config"
terraform plan
terraform apply
</code></pre>
<h2 id="configure-variables-5"><a class="header" href="#configure-variables-5">Configure Variables</a></h2>
<p>The following variables will be prompted during deployment:</p>
<div class="table-wrapper"><table><thead><tr><th>Variable</th><th>Description</th><th>Type</th><th>Default</th><th>Required</th></tr></thead><tbody>
<tr><td><code>admin_username</code></td><td>Username for admin user</td><td><code>string</code></td><td>-</td><td>Yes</td></tr>
<tr><td><code>admin_password</code></td><td>Password for admin user</td><td><code>string</code></td><td>-</td><td>Yes</td></tr>
</tbody></table>
</div>
<h2 id="post-deployment-setup"><a class="header" href="#post-deployment-setup">Post-Deployment Setup</a></h2>
<h3 id="access-vault-ui"><a class="header" href="#access-vault-ui"><strong>Access Vault UI</strong></a></h3>
<ol>
<li>
<p><strong>Navigate to Vault UI</strong>:</p>
<pre><code>https://&lt;vm-ip&gt;:8200/ui
</code></pre>
</li>
<li>
<p><strong>Login with root token</strong>:</p>
<ul>
<li>Use token from <code>vault_init_output.txt</code></li>
<li>Format: <code>hvs.&lt;token-value&gt;</code></li>
</ul>
</li>
</ol>
<h3 id="create-required-secrets"><a class="header" href="#create-required-secrets"><strong>Create Required Secrets</strong></a></h3>
<p>Navigate to <code>Secrets / kv_secrets / proxmox</code> and create the following KV secrets:</p>
<h4 id="ansible-configuration"><a class="header" href="#ansible-configuration"><strong>Ansible Configuration</strong></a></h4>
<ul>
<li><strong>Secret Name</strong>: <code>ansible_config</code></li>
<li><strong>Required Fields</strong>:
<ul>
<li><code>ssh_user</code>: SSH username for Ansible connections</li>
</ul>
</li>
</ul>
<h4 id="default-vm-credentials"><a class="header" href="#default-vm-credentials"><strong>Default VM Credentials</strong></a></h4>
<ul>
<li><strong>Secret Name</strong>: <code>default_vm_credential</code></li>
<li><strong>Required Fields</strong>:
<ul>
<li><code>username</code>: Default VM username (e.g., <code>ubuntu</code>, <code>root</code>)</li>
<li><code>password</code>: Default VM password</li>
</ul>
</li>
</ul>
<h4 id="proxmox-host-configuration"><a class="header" href="#proxmox-host-configuration"><strong>Proxmox Host Configuration</strong></a></h4>
<ul>
<li><strong>Secret Name</strong>: <code>host</code></li>
<li><strong>Required Fields</strong>:
<ul>
<li><code>endpoint</code>: Proxmox server URL (e.g., <code>https://192.168.1.100:8006</code>)</li>
<li><code>gateway_address</code>: Network gateway IP (e.g., <code>192.168.1.1</code>)</li>
<li><code>nodename</code>: Proxmox node name (e.g., <code>pve</code>)</li>
</ul>
</li>
</ul>
<h4 id="terraform-pve-credentials"><a class="header" href="#terraform-pve-credentials"><strong>Terraform PVE Credentials</strong></a></h4>
<ul>
<li><strong>Secret Name</strong>: <code>terraform_pve_credential</code></li>
<li><strong>Required Fields</strong>:
<ul>
<li><code>user_id</code>: PVE user ID (e.g., <code>terraform@pve</code>)</li>
<li><code>password</code>: PVE user password</li>
</ul>
</li>
</ul>
<h4 id="pve-control-api-token"><a class="header" href="#pve-control-api-token"><strong>PVE Control API Token</strong></a></h4>
<ul>
<li><strong>Secret Name</strong>: <code>terraform_pve_token</code></li>
<li><strong>Required Fields</strong>:
<ul>
<li><code>token_name</code>: API token name (e.g., <code>deployment-token</code>)</li>
<li><code>token_secret</code>: API token secret key (Generated secret value from Proxmox UI)</li>
<li><code>token_username</code>: Associated username (e.g., <code>terraform@pve</code>)</li>
</ul>
</li>
</ul>
<blockquote>
<p><strong>Security Note</strong>: Store all credentials securely and rotate them regularly. These secrets provide access to your Proxmox infrastructure and should be treated as highly sensitive.</p>
</blockquote>
<p>After setting, you should have similar UI like this:
<img src="initial_setup/vault/./images/kv.png" alt="kv_secrest" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="deployment-modules-reference"><a class="header" href="#deployment-modules-reference">Deployment Modules Reference</a></h1>
<p>This page contains all relevant materials and documentation referenced during the development of this homelab setup. The resources are organized by tool for easy navigation.</p>
<h2 id="proxmox"><a class="header" href="#proxmox">Proxmox</a></h2>
<ul>
<li><strong><a href="https://pve.proxmox.com/pve-docs/api-viewer/index.html">Proxmox API Reference</a></strong> - Complete API reference for Proxmox VE management and automation</li>
</ul>
<h2 id="packer"><a class="header" href="#packer">Packer</a></h2>
<ul>
<li><strong><a href="https://developer.hashicorp.com/packer/docs/commands">Packer Commands</a></strong> - Complete reference for all Packer CLI commands and their usage</li>
<li><strong><a href="https://developer.hashicorp.com/packer/docs/templates/hcl_templates">HCL Templates</a></strong> - Documentation for HashiCorp Configuration Language templates used in Packer</li>
<li><strong><a href="https://developer.hashicorp.com/packer/integrations/hashicorp/proxmox">Proxmox Integration</a></strong> - Official Packer plugin for Proxmox VE integration</li>
</ul>
<h2 id="terraform"><a class="header" href="#terraform">Terraform</a></h2>
<ul>
<li><strong><a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs">AWS Provider</a></strong> - Official Terraform provider for Amazon Web Services</li>
<li><strong><a href="https://registry.terraform.io/providers/bpg/proxmox/latest">Proxmox Provider</a></strong> - Community Terraform provider for Proxmox VE management</li>
<li><strong><a href="https://registry.terraform.io/providers/hashicorp/vault/latest">Vault Provider</a></strong> - Official Terraform provider for HashiCorp Vault</li>
</ul>
<h2 id="vault"><a class="header" href="#vault">Vault</a></h2>
<ul>
<li><strong><a href="https://developer.hashicorp.com/vault/docs/concepts/seal">Vault Sealing Concepts</a></strong> - Understanding Vault’s sealing and unsealing process for security</li>
<li><strong><a href="https://developer.hashicorp.com/vault/tutorials/get-started">Vault Getting Started</a></strong> - Comprehensive tutorial for Vault setup and basic operations</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>


    </div>
    </body>
</html>
